<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Telegram Mini Game â€” Runner</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
  <style>
    html, body { height:100%; margin:0; background: linear-gradient(#87CEEB, #ffffff); }
    #game-container { width:100%; height:100vh; display:flex; align-items:center; justify-content:center; }
    canvas { max-width:100%; height:auto; }
    .overlay { position: absolute; top:10px; left:10px; font-family: Arial, Helvetica, sans-serif; color:#222; background: rgba(255,255,255,0.75); padding:6px 8px; border-radius:6px; }
  </style>
</head>
<body>
  <div id="game-container"></div>
  <div class="overlay" id="hud">Score: 0</div>

<script>
const WIDTH = Math.min(window.innerWidth, 900);
const HEIGHT = Math.min(window.innerHeight, 600);

class Boot extends Phaser.Scene {
  constructor(){ super('Boot'); }
  create(){ this.scene.start('Main'); }
}

class Main extends Phaser.Scene {
  constructor(){ super('Main'); }
  init(){ this.score = 0; this.gameOver = false; }

  create(){
    const groundH = 96;

    // --- BACKGROUND ---
    const bgGraphics = this.make.graphics({add:false});
    bgGraphics.fillStyle(0x8ed6ff, 1);
    bgGraphics.fillRect(0,0,200,HEIGHT); // sky
    bgGraphics.generateTexture('bg', 200, HEIGHT);
    this.bg1 = this.add.tileSprite(0,0,WIDTH,HEIGHT,'bg').setOrigin(0);

    const hills = this.make.graphics({add:false});
    hills.fillStyle(0x2b8a3e, 1);
    hills.fillEllipse(50, HEIGHT-30, 140, 60);
    hills.fillEllipse(150, HEIGHT-40, 180, 80);
    hills.generateTexture('hills', 200, HEIGHT);
    this.bg2 = this.add.tileSprite(0, HEIGHT*0.4, WIDTH, HEIGHT*0.6, 'hills').setOrigin(0);

    // --- GROUND ---
    const groundG = this.make.graphics({add:false});
    groundG.fillStyle(0x6b4f2f,1);
    groundG.fillRect(0,0,200,groundH);
    groundG.lineStyle(2, 0x5a3f2a,1);
    for(let i=0;i<3;i++){ groundG.strokeRect(i*60,0,50,groundH); }
    groundG.generateTexture('ground',200,groundH);
    this.ground = this.add.tileSprite(0, HEIGHT - groundH, WIDTH, groundH, 'ground').setOrigin(0);

    // --- PLAYER ---
    const p = this.make.graphics({add:false});
    p.fillStyle(0xffd166,1); p.fillRoundedRect(0,0,60,60,10);
    p.lineStyle(3,0xff9f1c,1); p.strokeRoundedRect(0,0,60,60,10);
    p.generateTexture('player',60,60);

    this.physics.world.setBounds(0,0,999999, HEIGHT);
    this.player = this.physics.add.sprite(120, HEIGHT-groundH-30,'player').setCollideWorldBounds(true);
    this.player.body.setSize(48,56,true);
    this.player.setGravityY(1400);

    // --- FLOOR COLLIDER ---
    this.floor = this.physics.add.staticGroup();
    this.floor.create(WIDTH/2, HEIGHT-groundH/2, 'ground').setVisible(false).setScale(1).refreshBody();
    this.physics.add.collider(this.player, this.floor);

    // --- GROUPS ---
    this.obstacles = this.physics.add.group();
    this.coins = this.physics.add.group();
    this.physics.add.collider(this.player, this.obstacles, this.hitObstacle, null, this);
    this.physics.add.overlap(this.player, this.coins, this.collectCoin, null, this);

    // --- CONTROLS ---
    this.cursors = this.input.keyboard.createCursorKeys();
    this.input.on('pointerdown', ()=>this.tryJump());

    // --- SPAWN TIMERS ---
    this.spawnTimer = this.time.addEvent({ delay: 1200, callback: this.spawnObstacle, callbackScope: this, loop:true });
    this.coinTimer = this.time.addEvent({ delay: 900, callback: this.spawnCoin, callbackScope: this, loop:true });

    // --- HUD ---
    this.hud = document.getElementById('hud');
    this.updateHUD();

    // --- CAMERA ---
    this.cameras.main.startFollow(this.player, false, 0.08, 0.08);
    this.cameras.main.setBounds(0,0,999999, HEIGHT);

    // --- WORLD SPEED ---
    this.worldSpeed = 340;

    // --- PARTICLE TRAIL ---
    const coinGraphics = this.make.graphics({add:false});
    coinGraphics.fillStyle(0xffd700,1); coinGraphics.fillCircle(16,16,14);
    coinGraphics.lineStyle(3,0xffa500,1); coinGraphics.strokeCircle(16,16,14);
    coinGraphics.generateTexture('coin',32,32);
    this.particles = this.add.particles('coin');
    this.emitter = this.particles.createEmitter({ x:this.player.x-20, y:this.player.y+10, speed:{min:-40,max:40}, lifespan:400, scale:{start:0.25,end:0}, frequency:90 });

    // MOBILE HINT
    if(/Mobi|Android/i.test(navigator.userAgent)){
      this.add.text(20,20,'Tap to jump', {font:'16px Arial', fill:'#222'}).setScrollFactor(0).setDepth(5);
    }
  }

  update(time, delta){
    if(this.gameOver) return;

    const step = this.worldSpeed * delta/1000;
    this.ground.tilePositionX += step*0.4;
    this.bg1.tilePositionX += step*0.12;
    this.bg2.tilePositionX += step*0.22;

    Phaser.Actions.Call(this.obstacles.getChildren(), o=>{ o.x -= step; if(o.x<this.cameras.main.worldView.x-100) o.destroy(); });
    Phaser.Actions.Call(this.coins.getChildren(), c=>{ c.x -= step; if(c.x<this.cameras.main.worldView.x-100) c.destroy(); });

    if(this.cursors.up.isDown || this.cursors.space.isDown) this.tryJump();
    this.emitter.setPosition(this.player.x-20,this.player.y+10);

    if(Math.floor(time/10000)>0) this.worldSpeed = 340 + Math.floor(time/10000)*20;
  }

  tryJump(){
    if(this.player.body.touching.down || this.player.body.onFloor()){
      this.player.setVelocityY(-620);
      this.tweens.add({ targets:this.player, duration:120, scale:1.05, yoyo:true });
    }
  }

  spawnObstacle(){
    const oGraphics = this.make.graphics({add:false});
    oGraphics.fillStyle(0xff3b3b,1);
    oGraphics.beginPath(); oGraphics.moveTo(20,60); oGraphics.lineTo(40,0); oGraphics.lineTo(60,60); oGraphics.closePath(); oGraphics.fillPath();
    oGraphics.generateTexture('spike',60,60);

    const x = this.cameras.main.worldView.x + WIDTH + 60;
    const y = HEIGHT - 120;
    const sp = this.obstacles.create(x,y,'spike').setOrigin(0.5,1);
    sp.body.setAllowGravity(false);
    sp.setImmovable(true);
  }

  spawnCoin(){
    const x = this.cameras.main.worldView.x + WIDTH + Phaser.Math.Between(20,140);
    const y = Phaser.Math.Between(HEIGHT - 220, HEIGHT - 160);
    const c = this.coins.create(x,y,'coin'); c.body.setAllowGravity(false); c.setCircle(14);
  }

  collectCoin(player, coin){
    coin.destroy(); this.score += 10; this.updateHUD();
    const pop = this.add.text(player.x,player.y-40,'+10',{font:'18px Arial', fill:'#222'}).setOrigin(0.5);
    this.tweens.add({ targets:pop, y:pop.y-30, alpha:0, duration:700, onComplete: ()=>pop.destroy() });
  }

  hitObstacle(){
    this.gameOver = true;
    this.player.setTint(0xff6666);
    this.player.setVelocity(0,0);
    this.spawnTimer.remove(); this.coinTimer.remove();

    this.add.text(this.cameras.main.worldView.x+WIDTH/2, HEIGHT/2-40,'Game Over',{fontSize:'40px', fontFamily:'Arial', color:'#222'}).setOrigin(0.5);
    this.add.text(this.cameras.main.worldView.x+WIDTH/2, HEIGHT/2+10,'Score: '+this.score,{fontSize:'22px', fontFamily:'Arial', color:'#222'}).setOrigin(0.5);

    const btn = this.add.text(this.cameras.main.worldView.x+WIDTH/2, HEIGHT/2+70,'Play again',{fontSize:'20px', fontFamily:'Arial', backgroundColor:'#2b8a3e', padding:{x:10,y:8}, color:'#fff'}).setOrigin(0.5).setInteractive();
    btn.on('pointerdown', ()=>this.scene.restart());
  }

  updateHUD(){ this.hud.innerText = 'Score: ' + this.score; }
}

const config = {
  type: Phaser.AUTO,
  parent: 'game-container',
  width: WIDTH,
  height: HEIGHT,
  physics: { default: 'arcade', arcade: { gravity: {y:0}, debug:false } },
  scene: [Boot, Main]
};

window.addEventListener('load', ()=>{ window.game = new Phaser.Game(config); });
window.addEventListener('resize', ()=>{ location.reload(); });
</script>
</body>
</html>
